<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ì‹œí”„íŠ¸ ì•Œë¦¼</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body {
    font-family: "Segoe UI", sans-serif;
    background: #f5f7fb;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    min-height: 100vh;
    padding: 30px;
  }
  .card {
    background: white;
    border-radius: 14px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    padding: 22px;
    width: 560px;
    max-width: 100%;
    position: relative;
  }
  .title-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 14px;
    flex-wrap: wrap;
    gap: 10px;
  }
  .title {
    font-size: 22px;
    font-weight: bold;
    color: #222;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .btns {
    display: flex;
    gap: 8px;
  }
  .btns button {
    border: none;
    padding: 8px 14px;
    border-radius: 6px;
    cursor: pointer;
    background: #FF6699;
    color: white;
    font-size: 14px;
    font-weight: 500;
  }
  .btns button:hover { opacity: 0.85; }

  .room-wrap {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 15px;
    color: #333;
    margin-bottom: 10px;
  }
  .room-wrap input {
    border: 1px solid #aaa;
    border-radius: 6px;
    padding: 4px 8px;
    font-size: 15px;
    width: 90px;
    text-align: center;
  }

  .changes {
    font-size: 15px;
    margin: 12px 0 6px;
    color: #111;
  }
  .info {
    font-size: 14px;
    color: #444;
    margin: 5px 0;
    text-align: left;
  }

  .next-box {
    background: #ffe1eb;
    border-left: 6px solid #FF6699;
    padding: 12px 14px;
    border-radius: 8px;
    margin-top: 18px;
    font-size: 15px;
    font-weight: bold;
    color: #222;
  }

  .blink {
    background: #d9534f;
    color: white;
    text-align: center;
    padding: 12px;
    border-radius: 8px;
    font-size: 18px;
    margin-top: 15px;
    animation: blinker 1s linear infinite;
  }
  @keyframes blinker { 50% { opacity: 0; } }

  .update-time {
    font-size: 12px;
    color: #666;
    text-align: right;
    margin-top: 10px;
  }

  /* âœ… ëª¨ë°”ì¼ ìµœì í™” */
  @media (max-width: 600px) {
    body {
      padding: 16px;
    }
    .card {
      width: 100%;
      padding: 16px;
    }
    .title {
      font-size: 20px;
    }
    .btns button {
      padding: 6px 12px;
      font-size: 13px;
    }
    .room-wrap input {
      width: 70px;
    }
  }
</style>
</head>
<body>

<div class="card">
  <div class="title-row">
    <div class="title">ğŸ“¢ ì‹œí”„íŠ¸ ì•Œë¦¼</div>
    <div class="btns">
      <button onclick="update()">ìƒˆë¡œê³ ì¹¨</button>
      <button onclick="copyContent()">í´ë¦½ë³´ë“œ ë³µì‚¬</button>
    </div>
  </div>

  <div class="room-wrap">
    <span>ë°©ë²ˆí˜¸:</span>
    <input type="number" id="roomInput" placeholder="0000">
  </div>

  <div id="shift" class="changes"></div>
  <div id="changes" class="changes"></div>

  <div class="info">ğŸ¹ 55ë¶„ ì „ê¹Œì§€ ì²´í¬(âœ”) ë¶€íƒë“œë¦½ë‹ˆë‹¤.</div>
  <div class="info">ğŸ¹ ì…ì¥ ì „ [í—¬í¼ë±, ì—”ë¹„ ì„ ê³¡] í™•ì¸í•´ì£¼ì„¸ìš”.</div>
  <div class="info">ğŸ¹ ë§‰íŒì¶œ ì•Œë¦¼ ì‹œ ë°©ë²ˆí˜¸ë¥¼ ë¯¸ë¦¬ ì…ë ¥ í›„ ëŒ€ê¸° ë¶€íƒë“œë¦½ë‹ˆë‹¤.</div>

  <div id="next" class="next-box"></div>
  <div id="blink"></div>
  <div id="updateTime" class="update-time"></div>
</div>

<script>
const API_KEY = "AIzaSyC9w2ze2D8AeF2RVpXOS8h6_yM_bfGs5ok";
const SHEET_ID = "1Kst1MBWuDNy2HFqA_QQDoFL5f70Zgw586JkTBIpP2Hg";
const RANGE = "ì‹œíŠ¸1!A:Z";

const roomInput = document.getElementById("roomInput");
roomInput.value = localStorage.getItem("room") || "";
roomInput.addEventListener("input", () => {
  localStorage.setItem("room", roomInput.value.trim());
});

let lastNextHour = "";
let lastNextTime = null; // ë³€ë™ì´ ìˆëŠ” ë‹¤ìŒ ì‹œí”„íŠ¸ì˜ ì‹¤ì œ Date

async function fetchSheet() {
  const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${RANGE}?key=${API_KEY}`;
  const res = await fetch(url);
  const data = await res.json();
  return data.values || [];
}

function getShiftIndex(rows, now) {
  const hour = now.getHours();
  const shiftStr = `${hour.toString().padStart(2,"0")}:00 ~ ${(hour+1).toString().padStart(2,"0")}:00`;
  return rows.findIndex(r => (r[0] || "").trim() === shiftStr);
}

async function update() {
  try {
    const rows = await fetchSheet();
    const now = new Date();
    const idx = getShiftIndex(rows, now);

    if (idx < 1 || idx >= rows.length) {
      document.getElementById("shift").innerText = "í˜„ì¬ ì‹œí”„íŠ¸ ì—†ìŒ";
      document.getElementById("changes").innerText = "";
      document.getElementById("next").innerText = "";
      document.getElementById("blink").innerHTML = "";
      return;
    }

    const prev = rows[idx - 1];
    const curr = rows[idx];

    // í˜„ì¬ ì‹œí”„íŠ¸ ì œëª©
    const [currStart] = curr[0].split("~").map(s => s.trim());
    const [ch] = currStart.split(":");
    document.getElementById("shift").innerText = `ğŸ“¢ ${ch}ì‹œ ì‹œí”„íŠ¸ ì•Œë¦¼`;

    // ë³€ë™ ì¸ì› ê³„ì‚°
    const prevMembers = new Set(prev.slice(1).filter(Boolean));
    const currMembers = new Set(curr.slice(1).filter(Boolean));
    const left = [...prevMembers].filter(x => !currMembers.has(x));
    const joined = [...currMembers].filter(x => !prevMembers.has(x));

    if (left.length || joined.length) {
      let msg = "";
      if (left.length) msg += left.join(", ") + " â†’ ";
      if (joined.length) msg += joined.map(j => "@" + j).join(" ");
      document.getElementById("changes").innerText = msg;
    } else {
      document.getElementById("changes").innerText = "ì¸ì› ë³€ë™ ì—†ìŒ âœ…";
    }

    // ë‹¤ìŒ ë³€ë™ ì‹œí”„íŠ¸ ì°¾ê¸° (ì‹¤ì œ ë³€ë™ì´ ìˆëŠ” ì‹œê° ê¸°ì¤€)
    lastNextTime = null;
    lastNextHour = "";
    for (let i = idx + 1; i < rows.length; i++) {
      const pm = new Set(rows[i-1].slice(1).filter(Boolean));
      const cm = new Set(rows[i].slice(1).filter(Boolean));
      const l = [...pm].filter(x => !cm.has(x));
      const j = [...cm].filter(x => !pm.has(x));
      if (l.length || j.length) {
        const [start] = rows[i][0].split("~").map(s => s.trim());
        lastNextHour = start.split(":")[0];
        const [h, m] = start.split(":").map(Number);
        lastNextTime = new Date();
        lastNextTime.setHours(h, m, 0, 0);
        break;
      }
    }

    document.getElementById("next").innerText = lastNextHour ? `ğŸ”” ë‹¤ìŒ ì‹œí”„íŠ¸ ì•Œë¦¼ì€ ${lastNextHour}ì‹œì…ë‹ˆë‹¤.` : "";

    // 10ë¶„ ì „ ì•Œë¦¼ (ë‹¤ìŒ ë³€ë™ ì‹œí”„íŠ¸ ê¸°ì¤€)
    if (lastNextTime) {
      const alertStart = new Date(lastNextTime.getTime() - 10 * 60000);
      if (now >= alertStart && now < lastNextTime) {
        document.getElementById("blink").innerHTML =
          "<div class='blink'>ğŸš¨ ì‹œí”„íŠ¸ 10ë¶„ ì „ ì•Œë¦¼! ğŸš¨</div>";
      } else {
        document.getElementById("blink").innerHTML = "";
      }
    } else {
      document.getElementById("blink").innerHTML = "";
    }

    // ì—…ë°ì´íŠ¸ ì‹œê°„
    const timeStr = now.toLocaleString("ko-KR");
    document.getElementById("updateTime").innerText = `ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ${timeStr}`;

  } catch (e) {
    console.error(e);
    document.getElementById("changes").innerText = "ì‹œíŠ¸ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨";
  }
}

function copyContent() {
  const title = document.getElementById("shift").innerText;
  const roomVal = roomInput.value ? `[${roomInput.value}]` : "[ë°©ë²ˆí˜¸]";
  const changes = document.getElementById("changes").innerText;
  const infos = Array.from(document.querySelectorAll(".info")).map(e => e.innerText).join("\n");
  const tail = lastNextHour ? `\n\nğŸ”” ë‹¤ìŒ ì‹œí”„íŠ¸ ì•Œë¦¼ì€ ${lastNextHour}ì‹œì…ë‹ˆë‹¤.` : "";

  const text = `${title}\n${roomVal}\n\n${changes}\n\n${infos}${tail}`;
  navigator.clipboard.writeText(text).then(() => {
    alert("ë³µì‚¬ ì™„ë£Œ! ğŸ“‹");
  });
}

update();
setInterval(update, 60000);
</script>

</body>
</html>
